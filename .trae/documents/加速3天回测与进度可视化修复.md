## 背景与解释
- 侧边栏进度受限：常见进度条（如`tqdm`）依赖“同一行覆盖”输出（用回车字符更新一行）。很多IDE侧边栏只截取最新几行或不渲染这些覆盖效果，因此看起来始终是“0%”。在真正的终端（交互式TTY）能正常动态刷新，但在侧边栏或日志尾部视图会被截断或只显示第一帧。
- 报错定位：`KeyboardInterrupt`发生在`更新持仓统计`阶段对`sum(多头持仓价)`与`sum(空头持仓价)`的频繁全列表求和，性能开销大，导致长时间未完成，用户手动中断而形成堆栈。根因是每次价格推进都在循环里做O(N)统计。

## 目标
- 用最近3天数据窗口稳定跑通，几秒～几十秒内给出完整结果与图。
- 进度在侧边栏也能“增长”（非覆盖式文本行），显示ETA。

## 数据加载与进度显示
- 优先使用H5的table格式按时间窗口`where`加载，避免全量读取；保留失败时的安全回退（末尾行近似/全集裁剪）。
- 关闭/弱化`tqdm`的动态刷新，改为每固定步数输出一行纯文本进度：`已处理/总数（百分比） ETA(秒)`并`flush`，确保侧边栏能看到递增行。

## 核心算法优化（SOTA）
- 批量计算触网次数：
  - 对每个K线路径段（`curr→open→high/low→…→close`），用公式一次性算出跨越的档数`n = floor((目标价-当前价)/步长)`（上行为正，下行为负）。
  - 批量处理`n`次成交，不用`while True`逐格循环，极大降低时间复杂度。
- O(1)持仓统计：
  - 维护`多头持仓数/空头持仓数`与`多头价格总和/空头价格总和`，持仓浮盈与成本用常数时间更新；配对时同步更新总和与计数，避免`sum(list)`。
- 边界与一致性：
  - 到达`min_price/max_price`时重建网格；费用继续按maker/taker `bps`计算；事件顺序遵守您给定的K线轨迹规则。

## 验证步骤
- 设置3天窗口（例如`2025-06-12`至`2025-06-15`）运行回测。
- 输出`results.json`与`results.png`（净值/回撤/配对收益分布），并生成该窗口的`Parquet`缓存。
- 记录耗时与若干进度打印片段，确认侧边栏能看到百分比增长与ETA。

## 交付与预期
- 3天窗口：在批量触网+O(1)统计后，应在几秒到数十秒完成（取决于`grid_step`与价格波动）。
- 指标包含：净值曲线、Sharpe、最大回撤、胜率、周转率、网格循环效率；不使用资金费率（永续）。

## 后续扩展
- 扩到1周/1月窗口；加入参数扫描（档距/数量/费用）生成对比报表。
- 若仍有热点，可用Numba为批量触网与费用计算加速。

请确认以上方案，我将按此计划实施优化并运行3天窗口，确保快速出结果与可见进度。