## 总体方案
- 基于你提供的`account_dict`三元组（`positions_grids/up_price/down_price`）与K线内价格运动路径，构建币安风格的1m网格回测引擎。
- 在每根K线内部，按“阳线：`curr→open→low→high→close`；阴线：`curr→open→high→low→close`”的顺序推进价格；每次价格越过`up_price/down_price`即视为“触网”，调用`update_order`更新账户与配对。

## 核心数据结构
- `account_dict`（扩展）：
  - `positions_grids`：当前持仓格数（正=净多，负=净空）。
  - `up_price`/`down_price`：下一档与上一档挂单价格。
  - `pairing_count`：累计配对次数。
  - `pair_profit`：累计配对收益（扣费后）。
  - `positions_cost`：未配对持仓的成本合计。
  - `positions_profit`：未配对持仓的浮动盈亏（基于`curr_price`）。
  - `max_profit`/`max_loss`：回测过程中的最大盈亏轨迹。
- `grid_dict`：`min_price/max_price/grid_step/grid_count/base_qty`等网格参数。

## 价格推进与触网判定
- 维护`curr_price`（上一步价格）。在K线内依序调用`update_price(ts, new_price)`进行多次推进。
- 在`update_price`中：
  - 若`new_price`与`curr_price`差值小于`eps`，返回。
  - 若价格向上且`new_price < up_price - eps`或向下且`new_price > down_price + eps`，仅更新`curr_price`，不触网。
  - 否则说明触网：
    - 向上触网：`SELL @ up_price`，`positions_grids -= 1`；
    - 向下触网：`BUY @ down_price`，`positions_grids += 1`；
  - 触网后重算`positions_cost/positions_profit`与`pair_profit`；并根据是否越界`min/max_price`决定`reset_grid`或设置新的`up/down_price`。

## 配对与盈亏计算
- 配对定义：当触网操作使`positions_grids`向0靠近并跨过0侧（例如从+3到+2表示平掉一格的空配对，或从-3到-2表示平掉一格的多配对），则产生一次配对收益。
- 单次配对收益：
  - 理想：`grid_step * base_qty`，方向取决于多空；
  - 实际：扣除买入与卖出两侧费用（`maker/taker`可配置），以及可选`slippage_bps`；
  - 计入`pair_profit`并累加`pairing_count`。
- 未配对盈亏：由`positions_grids`在网格各价位的未平仓集合与当前`curr_price`计算。

## 撮合与费用
- 费用：`maker_fee_bps/taker_fee_bps`可配置；默认网格使用`POST_ONLY`限价偏向`maker`（可切换为保守`taker`模式）。
- 市价（若策略有用到）：按`close`价加`slippage_bps`。
- 保证金/杠杆：参数化支持；默认按USDT永续；若你使用现货，关闭杠杆与保证金模块。

## 初始化与边界
- `_init_strategy()`：根据`curr_price`与`grid_step`计算首个`up_price/down_price`；并确保在`min/max_price`边界内。
- `reset_grid()`：当价格越界时重建网格（可选择“跟随价格移动网格”或“固定边界重建”两种策略）。
- `eps`：数值容差，避免浮点误判触网。

## 指标与输出
- 账户与策略：`pair_profit/positions_profit/max_profit/max_loss/pairing_count/循环次数/资金利用率`。
- 绩效：`净值曲线/累计收益/年化APR/Sharpe/最大回撤/胜率`。
- 导出：`orders_fills.csv`、`results.json`（含全部指标与配置快照）。

## 对接与运行
- 适配器：`BacktestExchangeBinance1m`实现“下单/触网/成交/撤单”事件；与现有`GridEngineImpl/GridStrategyImpl`兼容或平行驱动（根据你现有接口决定）。
- 运行器：`BacktestRunnerGrid`读取数据→推进每根K线→事件驱动更新；支持多交易对批量回测。
- 运行：`python -X utf8 run_backtest_grid.py -c config/backtest/grid_binance_1m.yaml`。

## 测试（AAA，覆盖>80%）
- K线内路径：阳/阴线两种序列的触网与不触网用例。
- 三元组维护：`positions_grids/up_price/down_price`更新正确性与边界条件。
- 配对收益：在不同费率与步距下的配对数与收益一致性。
- 网格重建：越界后的`reset_grid`策略正确性。
- 指标：APR/回撤/Sharpe在若干已知样例上的可复现性。

## 你需要提供
- 1m历史K线（UTC）与基本参数：`grid_step/grid_count/base_qty/min_price/max_price`、费率、永续或现货、初始资金。