## 目标
- 在现有网页中整合交互式价格图（多面板）、时间框切换、交易标记点击详情。
- 细化交易标记文本（费用、撮合模式maker/taker、配对收益）。
- 支持同窗对比：多条净值曲线与多指标线，便于参数组合横向比较。

## 技术路线
- 前端：直接集成TradingView Lightweight Charts的Web版（JS CDN），实现交互与多面板；顶部提供时间框切换（1m/5m/15m/1H/4H/1D）、多选结果对比、指标开关；多面板通过多个同步Chart实现（共享时间轴与十字光标事件）。参考文档示例支持子图联动与面板创建（来源：lightweight-charts-python文档 Subcharts 示例）。
- 后端API：在现有server基础上新增接口，返回真实回测数据，不使用模拟数据：
  - `/api/ohlc?name=...&tf=...`：返回价格序列（按tf重采样），列：`time|open|high|low|close|volume`。
  - `/api/trades?name=...`：返回交易标记，字段：`ts, side(BUY/SELL), offset(OPEN/CLOSE), price, qty, fee, mode(maker/taker), pair_profit`。
  - `/api/nav?names=a,b,...`：返回多结果的净值曲线列表，含`name`与`[{time, nav}]`。
  - `/api/indicator?name=...&type=sma&period=20`：后端计算并返回指标序列（可选，前端也可自行计算）。
- 数据标准化：后端统一将时间转`ISO或epoch ms`，字段名与TV库一致；对tf进行pandas重采样（OHLC聚合、volume汇总）。

## 前端交互设计
- 顶部工具条：
  - 结果多选（下拉+复选），时间框切换（1m/5m/15m/1H/4H/1D），指标选择（SMA/EMA/RSI/布林带）。
  - 开关：显示交易标记、显示净值子图、显示收益分布子图。
- 多面板：
  - 主面板：价格K线+叠加指标线；
  - 子面板1：净值曲线（可叠加多条）；
  - 子面板2：配对收益直方图或配对时刻垂线；
  - 面板同步：时间轴联动与十字光标位置同步。
- 交易标记点击详情：
  - 在标记点附近显示浮层（价格、数量、费用、撮合模式、该次配对收益）；
  - 切换显示策略：hover提示 + click固定。
- 对比模式：
  - 多结果的净值与指标线可叠加显示，提供颜色映射与图例。
  - 结果切换会触发API刷新并重绘。

## 后端扩展与适配
- 在回测结果中已导出`trade_marks`，计划扩充字段：费用`fee`、撮合模式`mode`、该次配对收益`pair_profit`（来自成交与配对逻辑）。
- 新增重采样与指标计算工具：SMA/EMA/RSI/布林带；默认指标可由前端计算以减轻后端负担。
- 缓存：对`ohlc(tf)`与`indicator`结果进行文件或内存缓存，提升交互性能。

## 验证与测试
- 前端：用Playwright进行端到端测试（加载数据、切换时间框、点击标记弹出详情、选择多结果叠加）；
- 后端：单元测试覆盖数据重采样、指标计算、交易标记字段完整性与正确性（AAA模式）。
- 性能：确保3天窗口下渲染与交互顺畅；大窗口时走缓存与分页策略。

## 交付内容
- server接口扩展与安全校验（仅本地文件访问）。
- 前端页面升级：集成TV Lightweight Charts、工具条、面板、标记交互、对比模式。
- 示例脚本：示范从回测`results_*.json`加载并在网页展示。

## 后续增强
- 顶部参数面板：网页内一键重跑回测（传参到入口脚本），跑完自动进入对比；
- 交互回放：沿时间轴播放交易事件；
- 报告导出：一键生成HTML/PDF报告（指标与图表）。

请确认以上方案，确认后我将实现后端接口与前端交互页面，并进行自动化验证。